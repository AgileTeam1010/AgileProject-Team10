<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <link rel="stylesheet" href="stylelogin.css">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Irish+Grover&display=swap" rel="stylesheet">
</head>

<body>
  <header class="top-header">
    <div class="left-header">
      <a href="index.html">
        <input type="image" src="pictures/computercat.png" class="btTxt submit" id="saveForm" />
      </a>
      <h1>CatCulation</h1>
    </div>
    <div class="right-header">
      <a href="aboutUs.html" class="righttablink">About us</a>
      <div class="search-box">
        <button class="search-icon">üîç</button>
        <input type="search" id="siteSearch" placeholder="Search...">
      </div>
      <button class="logout-btn" onclick="logout()">Log out</button>
    </div>
  </header>

  <div class="content">
    <aside class="side-left">
      <h1>Topics</h1>
      <a href="addition/addition.html" class="level">‚ûï Addition</a>
      <a href="subtraction/subtraction.html" class="level">‚ûñ Subtraction</a>
      <a href="multiplication/multiplication.html" class="level">‚úñÔ∏è Multiplication</a>
      <a href="Division/division.html" class="level">‚ûó Division</a>
      <a href="mixed/mixed.html" class="level">üé≤ Mixed</a>
    </aside>

    <main class="index-container">
      <div class="white-section">
        <h2>Profile</h2>
        <p id="userEmail">Loading user...</p>
        <div class="profile-cat">
          <img src="pictures/profilecat.png" alt="Profile Cat">
        </div>
        <div class="p-left">
          <h2>Your Progress</h2>
          <div id="progressContainer" class="progress-list">
            Loading progress...
          </div>
        </div>
      </div>
    </main>

    <aside class="side-right">
      <img src="../pictures/advertisement.webp" alt="Advertisement">
    </aside>
  </div>

  <script type="module" src="authState.js"></script>

<script type="module">
  import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const auth = window._auth;
  const db = window._db;

  window.logout = async function () {
    try {
      await signOut(auth);
      window.location.href = "index.html";
    } catch (err) {
      console.error("Logout error:", err);
    }
  };

  onAuthStateChanged(auth, async (user) => {
    const emailEl = document.getElementById("userEmail");
    const container = document.getElementById("progressContainer");

    if (!user) {
      window.location.href = "index.html";
      return;
    }

    emailEl.textContent = `Logged in as ${user.email}`;
    container.textContent = "Loading progress...";

    try {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      if (!snap.exists() || !snap.data().progress) {
        container.textContent = "No progress yet üí§";
        return;
      }

      const progress = snap.data().progress;
      renderProgress(progress, container);
    } catch (err) {
      console.error("Error loading progress:", err);
      container.textContent = "Error loading progress üòø";
    }
  });

  function renderProgress(progress, container) {
    container.innerHTML = "";
    const totalAnswered = Object.values(progress).reduce((sum, p) => sum + (p.answeredCount ?? 0), 0);

    const summary = document.createElement("p");
    summary.classList.add("progress-summary");
    summary.textContent = `üéØ Total questions answered: ${totalAnswered}`;
    container.appendChild(summary);

    for (const [topic, data] of Object.entries(progress)) {
      const div = document.createElement("div");
      div.classList.add("progress-item");
      div.innerHTML = `
        <h3>${topic.charAt(0).toUpperCase() + topic.slice(1)}</h3>
        <p>Questions answered: ${data.answeredCount ?? 0}</p>
        <p>Highest level: ${data.highestLevel ?? 1}</p>
      `;
      container.appendChild(div);
    }
  }
</script>


</body>
</html>
